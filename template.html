<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title><!-- __PAGE_TITLE__ --></title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:ital,wght@0,300;0,400;0,500;1,400&family=Newsreader:ital,opsz,wght@0,6..72,300..800;1,6..72,300..800&family=Outfit:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">
<!-- __THEME_OVERRIDE__ -->
<style>
  :root {
    --bg-primary: #0a0a0c;
    --bg-secondary: #111116;
    --bg-tertiary: #18181f;
    --bg-hover: #1e1e28;
    --border: #2a2a35;
    --border-active: #4a4a5a;
    --text-primary: #e8e6e3;
    --text-secondary: #9a9aab;
    --text-muted: #5e5e72;
    --accent: #c4956a;
    --accent-dim: #9a7554;
    --accent-glow: rgba(196, 149, 106, 0.12);
    --accent-bright: #daa87a;
    --code-bg: #0d0d12;
    --sidebar-width: 280px;
    --header-height: 56px;
    --footer-height: 60px;
    --content-max: 780px;
    --radius: 6px;
    --transition: 180ms ease;
  }
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html { font-size: 16px; scroll-behavior: smooth; }
  body {
    font-family: 'Outfit', sans-serif;
    background: var(--bg-primary);
    color: var(--text-primary);
    line-height: 1.6;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* ─── HEADER ─── */
  .site-header {
    position: fixed;
    top: 0; left: 0; right: 0;
    height: var(--header-height);
    background: rgba(10,10,12,0.85);
    backdrop-filter: blur(20px) saturate(1.4);
    -webkit-backdrop-filter: blur(20px) saturate(1.4);
    border-bottom: 1px solid var(--border);
    z-index: 100;
    display: flex;
    align-items: center;
    padding: 0 24px;
    gap: 16px;
  }
  .header-brand {
    font-family: 'DM Mono', monospace;
    font-weight: 500;
    font-size: 0.95rem;
    color: var(--accent);
    letter-spacing: 0.04em;
    text-decoration: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    flex-shrink: 0;
  }
  .header-brand svg { opacity: 0.85; }
  .header-breadcrumb {
    font-size: 0.8rem;
    color: var(--text-muted);
    font-family: 'DM Mono', monospace;
    overflow: hidden;
    white-space: nowrap;
    text-overflow: ellipsis;
    flex: 1;
  }
  .header-breadcrumb span { color: var(--text-secondary); }
  .menu-toggle {
    display: none;
    background: none;
    border: 1px solid var(--border);
    color: var(--text-secondary);
    padding: 6px 8px;
    border-radius: var(--radius);
    cursor: pointer;
    transition: var(--transition);
  }
  .menu-toggle:hover { border-color: var(--border-active); color: var(--text-primary); }

  /* ─── SOCIAL ICONS ─── */
  .header-social {
    display: flex;
    align-items: center;
    gap: 6px;
    flex-shrink: 0;
  }
  .header-social a {
    color: var(--text-muted);
    text-decoration: none;
    border: 1px solid var(--border);
    padding: 5px 7px;
    border-radius: var(--radius);
    transition: var(--transition);
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1;
  }
  .header-social a:hover { border-color: var(--border-active); color: var(--text-secondary); }

  /* ─── LAYOUT ─── */
  .layout {
    display: flex;
    margin-top: var(--header-height);
    min-height: calc(100vh - var(--header-height));
  }

  /* ─── SIDEBAR (Codelabs-style numbered steps) ─── */
  .sidebar {
    position: fixed;
    top: var(--header-height);
    left: 0;
    bottom: 0;
    width: var(--sidebar-width);
    background: var(--bg-secondary);
    border-right: 1px solid var(--border);
    overflow-y: auto;
    overflow-x: hidden;
    padding: 8px 0;
    z-index: 50;
    display: flex;
    flex-direction: column;
    transition: transform 300ms ease;
  }
  .sidebar::-webkit-scrollbar { width: 4px; }
  .sidebar::-webkit-scrollbar-track { background: transparent; }
  .sidebar::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  .step-list { list-style: none; padding: 0; margin: 0; flex: 1; overflow-y: auto; }
  .step-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    cursor: pointer;
    transition: var(--transition);
    border-left: 3px solid transparent;
    user-select: none;
  }
  .step-item:hover { background: var(--bg-hover); }
  .step-item.active {
    background: var(--accent-glow);
    border-left-color: var(--accent);
  }
  .step-item.completed .step-number {
    background: var(--accent);
    color: var(--bg-primary);
    border-color: var(--accent);
  }
  .step-number {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    border: 2px solid var(--border-active);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.72rem;
    font-weight: 600;
    font-family: 'DM Mono', monospace;
    color: var(--text-muted);
    flex-shrink: 0;
    transition: var(--transition);
  }
  .step-item.active .step-number {
    background: var(--accent);
    color: var(--bg-primary);
    border-color: var(--accent);
  }
  .step-title {
    font-size: 0.82rem;
    font-weight: 400;
    color: var(--text-secondary);
    line-height: 1.35;
    transition: var(--transition);
  }
  .step-item.active .step-title {
    color: var(--text-primary);
    font-weight: 500;
  }
  .step-item:hover .step-title { color: var(--text-primary); }

  /* ─── MAIN CONTENT ─── */
  .main-content {
    margin-left: var(--sidebar-width);
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
  }
  .content-scroll {
    max-width: calc(var(--content-max) + 80px);
    margin: 0 auto;
    padding: 48px 40px 100px;
    width: 100%;
    flex: 1;
  }

  /* ─── STEP NAVIGATION (Bottom bar) ─── */
  .step-nav {
    position: fixed;
    bottom: 0;
    left: var(--sidebar-width);
    right: 0;
    height: var(--footer-height);
    background: rgba(10,10,12,0.9);
    backdrop-filter: blur(16px);
    -webkit-backdrop-filter: blur(16px);
    border-top: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 40px;
    z-index: 90;
  }
  .step-nav-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 8px 20px;
    border-radius: var(--radius);
    font-family: 'Outfit', sans-serif;
    font-size: 0.85rem;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    text-decoration: none;
  }
  .step-nav-btn.back {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-secondary);
  }
  .step-nav-btn.back:hover { border-color: var(--border-active); color: var(--text-primary); }
  .step-nav-btn.next {
    background: var(--accent);
    border: 1px solid var(--accent);
    color: var(--bg-primary);
    font-weight: 600;
  }
  .step-nav-btn.next:hover { filter: brightness(1.1); }
  .step-nav-btn:disabled, .step-nav-btn.disabled {
    opacity: 0.3;
    cursor: default;
    pointer-events: none;
  }
  .step-nav-center {
    font-size: 0.75rem;
    color: var(--text-muted);
    font-family: 'DM Mono', monospace;
  }

  /* ─── CONFIG PANEL ─── */
  .config-panel {
    max-width: 560px;
    margin: 80px auto;
    padding: 0 40px;
    animation: fadeUp 400ms ease both;
  }
  .config-panel h1 {
    font-family: 'Newsreader', serif;
    font-size: 2rem;
    font-weight: 400;
    margin-bottom: 6px;
    color: var(--text-primary);
  }
  .config-panel p {
    color: var(--text-secondary);
    font-size: 0.88rem;
    margin-bottom: 32px;
    line-height: 1.7;
  }
  .config-field { margin-bottom: 20px; }
  .config-field label {
    display: block;
    font-size: 0.72rem;
    font-family: 'DM Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-bottom: 6px;
  }
  .config-field input {
    width: 100%;
    padding: 10px 14px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text-primary);
    font-family: 'DM Mono', monospace;
    font-size: 0.85rem;
    outline: none;
    transition: var(--transition);
  }
  .config-field input::placeholder { color: var(--text-muted); }
  .config-field input:focus { border-color: var(--accent-dim); box-shadow: 0 0 0 3px var(--accent-glow); }
  .config-field .hint { font-size: 0.72rem; color: var(--text-muted); margin-top: 4px; }
  .config-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 10px 24px;
    background: var(--accent);
    color: var(--bg-primary);
    border: none;
    border-radius: var(--radius);
    font-family: 'Outfit', sans-serif;
    font-size: 0.85rem;
    font-weight: 600;
    cursor: pointer;
    transition: var(--transition);
    margin-top: 8px;
  }
  .config-btn:hover { filter: brightness(1.1); transform: translateY(-1px); }
  .config-examples { margin-top: 36px; padding-top: 24px; border-top: 1px solid var(--border); }
  .config-examples h3 {
    font-size: 0.72rem;
    font-family: 'DM Mono', monospace;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-bottom: 12px;
  }
  .config-example-item {
    padding: 8px 12px;
    border-radius: var(--radius);
    cursor: pointer;
    transition: var(--transition);
    font-size: 0.82rem;
    color: var(--text-secondary);
    font-family: 'DM Mono', monospace;
  }
  .config-example-item:hover { background: var(--bg-hover); color: var(--accent); }

  /* ─── ARTICLE STYLES ─── */
  .article-meta {
    margin-bottom: 40px;
    padding-bottom: 24px;
    border-bottom: 1px solid var(--border);
  }
  .article-meta h1 {
    font-family: 'Newsreader', serif;
    font-size: 2.2rem;
    font-weight: 500;
    line-height: 1.25;
    margin-bottom: 12px;
    color: var(--text-primary);
    letter-spacing: -0.01em;
  }
  .article-meta .meta-row {
    display: flex;
    align-items: center;
    gap: 16px;
    font-size: 0.78rem;
    color: var(--text-muted);
    font-family: 'DM Mono', monospace;
  }
  .article-meta .meta-row .tag {
    background: var(--bg-tertiary);
    padding: 2px 8px;
    border-radius: 3px;
    font-size: 0.7rem;
  }
  .markdown-body {
    color: var(--text-secondary);
    line-height: 1.78;
    font-size: 0.95rem;
  }
  .markdown-body h1, .markdown-body h2, .markdown-body h3,
  .markdown-body h4, .markdown-body h5, .markdown-body h6 {
    color: var(--text-primary);
    font-family: 'Newsreader', serif;
    font-weight: 500;
    margin: 2em 0 0.6em;
    line-height: 1.3;
  }
  .markdown-body h1 { font-size: 1.8rem; }
  .markdown-body h2 { font-size: 1.45rem; border-bottom: 1px solid var(--border); padding-bottom: 8px; }
  .markdown-body h3 { font-size: 1.2rem; }
  .markdown-body h4 { font-size: 1.05rem; }
  .markdown-body p { margin: 0 0 1.2em; }
  .markdown-body a {
    color: var(--accent);
    text-decoration: underline;
    text-decoration-color: var(--accent-dim);
    text-underline-offset: 3px;
    transition: var(--transition);
  }
  .markdown-body a:hover { text-decoration-color: var(--accent); }
  .markdown-body strong { color: var(--text-primary); font-weight: 600; }
  .markdown-body blockquote {
    border-left: 3px solid var(--accent-dim);
    padding: 4px 0 4px 20px;
    margin: 1.5em 0;
    color: var(--text-muted);
    font-style: italic;
    font-family: 'Newsreader', serif;
    font-size: 1.05rem;
  }
  .markdown-body code {
    font-family: 'DM Mono', monospace;
    font-size: 0.84em;
    background: var(--code-bg);
    border: 1px solid var(--border);
    padding: 2px 6px;
    border-radius: 3px;
    color: var(--accent);
  }
  .markdown-body pre {
    background: var(--code-bg);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin: 1.5em 0;
    overflow-x: auto;
    position: relative;
  }
  .markdown-body pre code {
    background: none;
    border: none;
    padding: 0;
    font-size: 0.82rem;
    color: var(--text-secondary);
    line-height: 1.65;
  }
  .markdown-body img {
    max-width: 100%;
    border-radius: var(--radius);
    margin: 1.5em 0;
    border: 1px solid var(--border);
  }
  .markdown-body ul, .markdown-body ol { padding-left: 1.6em; margin: 0 0 1.2em; }
  .markdown-body li { margin-bottom: 0.4em; }
  .markdown-body table { width: 100%; border-collapse: collapse; margin: 1.5em 0; font-size: 0.88rem; }
  .markdown-body th, .markdown-body td { border: 1px solid var(--border); padding: 10px 14px; text-align: left; }
  .markdown-body th {
    background: var(--bg-tertiary);
    font-weight: 600;
    color: var(--text-primary);
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  .markdown-body hr { border: none; height: 1px; background: var(--border); margin: 2.5em 0; }

  /* YouTube embed */
  .youtube-embed {
    position: relative;
    padding-bottom: 56.25%;
    height: 0;
    overflow: hidden;
    margin: 1.5em 0;
    border-radius: var(--radius);
    border: 1px solid var(--border);
    background: var(--bg-tertiary);
  }
  .youtube-embed iframe {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    border: 0;
  }

  /* ─── COMMENTS ─── */
  .comments-section {
    margin-top: 64px;
    padding-top: 32px;
    border-top: 1px solid var(--border);
  }
  .comments-section h3 {
    font-family: 'DM Mono', monospace;
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.08em;
    color: var(--text-muted);
    margin-bottom: 20px;
  }

  /* ─── LOADING / ERRORS ─── */
  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 80px 20px;
    color: var(--text-muted);
    font-size: 0.85rem;
    gap: 16px;
  }
  .spinner {
    width: 28px; height: 28px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }
  .error-state { padding: 40px; text-align: center; color: var(--text-muted); }
  .error-state code {
    display: block;
    margin-top: 12px;
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    color: #e06c75;
  }

  /* ─── SCROLLBAR ─── */
  .main-content::-webkit-scrollbar { width: 6px; }
  .main-content::-webkit-scrollbar-track { background: transparent; }
  .main-content::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  /* ─── ANIMATIONS ─── */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to { opacity: 1; transform: translateY(0); }
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .fade-in { animation: fadeUp 350ms ease both; }

  /* ─── RESPONSIVE ─── */
  @media (max-width: 860px) {
    .sidebar { transform: translateX(-100%); }
    .sidebar.mobile-open {
      transform: translateX(0);
      box-shadow: 4px 0 24px rgba(0,0,0,0.5);
    }
    .main-content { margin-left: 0; }
    .step-nav { left: 0; }
    .content-scroll { padding: 32px 20px 100px; }
    .menu-toggle { display: block; }
    .article-meta h1 { font-size: 1.6rem; }
    .config-panel { padding: 0 20px; margin-top: 40px; }
  }
  .sidebar-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    z-index: 40;
  }
  .sidebar-overlay.visible { display: block; }

  /* Copy button for code blocks */
  .code-copy-btn {
    position: absolute;
    top: 8px;
    right: 8px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    color: var(--text-muted);
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 0.65rem;
    font-family: 'DM Mono', monospace;
    cursor: pointer;
    transition: var(--transition);
    opacity: 0;
  }
  pre:hover .code-copy-btn { opacity: 1; }
  .code-copy-btn:hover { color: var(--text-primary); border-color: var(--border-active); }

  /* ─── STEP SUB-ITEMS (h3/h4 under active step) ─── */
  .step-sub-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .step-sub-item {
    padding: 6px 16px 6px 56px;
    cursor: pointer;
    font-size: 0.75rem;
    color: var(--text-muted);
    transition: var(--transition);
    border-left: 3px solid transparent;
    line-height: 1.4;
  }
  .step-sub-item:hover {
    color: var(--text-secondary);
    background: var(--bg-hover);
  }
  .step-sub-item.active {
    color: var(--accent);
    border-left-color: var(--accent-dim);
  }
  .step-sub-item.depth-4 {
    padding-left: 68px;
  }
  .sidebar-footer {
    margin-top: auto;
    padding: 16px;
    border-top: 1px solid var(--border);
    text-align: center;
  }
  .sidebar-footer a {
    color: var(--text-muted);
    text-decoration: none;
    font-size: 0.7rem;
    letter-spacing: 0.03em;
    transition: var(--transition);
  }
  .sidebar-footer a:hover {
    color: var(--accent);
  }

  /* ─── FOLDER/BRANCH DROPDOWN (top of sidebar) ─── */
  .folder-dropdown-wrap, .branch-dropdown-wrap {
    padding: 8px 12px 4px;
    border-bottom: 1px solid var(--border);
    margin-bottom: 4px;
  }
  .branch-dropdown-wrap { padding-bottom: 0; border-bottom: none; margin-bottom: 0; }
  .folder-dropdown, .branch-dropdown {
    width: 100%;
    padding: 8px 10px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    color: var(--text-primary);
    font-family: 'Outfit', sans-serif;
    font-size: 0.82rem;
    font-weight: 500;
    cursor: pointer;
    outline: none;
    appearance: none;
    -webkit-appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%239a9aab' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
    padding-right: 28px;
    transition: var(--transition);
  }
  .branch-dropdown { font-family: 'DM Mono', monospace; font-size: 0.78rem; }
  .folder-dropdown:hover, .branch-dropdown:hover { border-color: var(--border-active); }
  .folder-dropdown:focus, .branch-dropdown:focus { border-color: var(--accent-dim); box-shadow: 0 0 0 2px var(--accent-glow); }
  .folder-dropdown option, .branch-dropdown option {
    background: var(--bg-secondary);
    color: var(--text-primary);
  }

</style>
</head>
<body>
<!-- HEADER -->
<header class="site-header">
  <button class="menu-toggle" onclick="toggleSidebar()" aria-label="Toggle menu">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18M3 6h18M3 18h18"/></svg>
  </button>
  <a class="header-brand" onclick="if(state.pages.length)loadPage(0)">
    <!-- __BRAND_LOGO__ -->
    <!-- __BRAND_NAME__ -->
  </a>
  <div class="header-breadcrumb" id="breadcrumb"></div>
  <div class="header-social" id="headerSocial"><!-- __SOCIAL_ICONS__ --></div>
</header>
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
<!-- LAYOUT -->
<div class="layout">
  <nav class="sidebar" id="sidebar">
    <div class="branch-dropdown-wrap" id="branchDropdownWrap" style="display:none;">
      <select class="branch-dropdown" id="branchDropdown" onchange="onBranchChange(this.value)"></select>
    </div>
    <div class="folder-dropdown-wrap" id="folderDropdownWrap" style="display:none;">
      <select class="folder-dropdown" id="folderDropdown" onchange="onFolderChange(this.value)"></select>
    </div>
    <ul class="step-list" id="stepList"></ul>
    <div class="sidebar-footer">
      <a href="https://github.com/darmie/markflow" target="_blank" rel="noopener">Powered by Markflow</a>
    </div>
  </nav>
  <main class="main-content" id="mainContent">
    <div class="content-scroll" id="contentArea">
      <div class="config-panel" id="configPanel">
        <h1>Connect a Repository</h1>
        <p>Point Markflow at any public GitHub repo containing Markdown files. The sidebar will show each doc as a numbered step, Codelabs-style.</p>
        <div class="config-field">
          <label>GitHub Owner</label>
          <input type="text" id="cfgOwner" placeholder="e.g. octocat" />
        </div>
        <div class="config-field">
          <label>Repository Name</label>
          <input type="text" id="cfgRepo" placeholder="e.g. my-docs" />
        </div>
        <div class="config-field">
          <label>Branch</label>
          <input type="text" id="cfgBranch" placeholder="main" value="main" />
        </div>
        <div class="config-field">
          <label>Root Path (optional)</label>
          <input type="text" id="cfgRoot" placeholder="e.g. docs or content/blog" />
          <div class="hint">Leave blank to use the entire repo</div>
        </div>
        <div class="config-field">
          <label>Giscus Repo (optional, for comments)</label>
          <input type="text" id="cfgGiscus" placeholder="e.g. owner/repo-discussions" />
          <div class="hint">Must have GitHub Discussions enabled with giscus app installed</div>
        </div>
        <button class="config-btn" onclick="loadRepo()">
          Load Repository
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
        </button>
        <div class="config-examples">
          <h3>Quick examples</h3>
          <div class="config-example-item" onclick="fillConfig('docsifyjs','docsify','main','docs')">docsifyjs/docsify → /docs</div>
          <div class="config-example-item" onclick="fillConfig('microsoft','vscode-docs','main','docs')">microsoft/vscode-docs → /docs</div>
          <div class="config-example-item" onclick="fillConfig('rust-lang','book','main','src')">rust-lang/book → /src</div>
        </div>
      </div>
    </div>
  </main>
</div>
<!-- STEP NAVIGATION BAR (hidden until repo loaded) -->
<div class="step-nav" id="stepNav" style="display:none;">
  <button class="step-nav-btn back" id="btnBack" onclick="prevStep()">
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
    Back
  </button>
  <span class="step-nav-center" id="stepCounter"></span>
  <button class="step-nav-btn next" id="btnNext" onclick="nextStep()">
    Next
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
  </button>
</div>

<script>
// ─── CONFIG & CONTENT (replaced by CLI build) ───
const __MARKFLOW_CONFIG__ = /* __MARKFLOW_CONFIG_PLACEHOLDER__ */ null;
const __MARKFLOW_CONTENT__ = /* __MARKFLOW_CONTENT_PLACEHOLDER__ */ null;

// ─── STATE ───
const state = {
  owner: '', repo: '', branch: 'main', root: '', giscusRepo: '',
  branchSwitcher: false,
  sections: [],      // { name, pages: [{ title, path }] } — groups of pages
  pages: [],         // flat list: [{ title, path, sectionIdx }]
  currentPage: -1,
  steps: [],         // h2 headings from current page: [{ text, id }]
  currentStep: -1,
  fileCache: new Map(),
  allFiles: new Set(),
  stepObserver: null
};

// ─── BOOT ───
(function boot() {
  if (__MARKFLOW_CONFIG__) {
    // CLI-built mode: hide config panel, load from embedded config
    document.getElementById('configPanel').style.display = 'none';
    state.owner = __MARKFLOW_CONFIG__.repo.owner;
    state.repo = __MARKFLOW_CONFIG__.repo.name;
    state.branch = __MARKFLOW_CONFIG__.repo.branch || 'main';
    state.root = __MARKFLOW_CONFIG__.repo.root || '';
    state.giscusRepo = __MARKFLOW_CONFIG__.giscus && __MARKFLOW_CONFIG__.giscus.repo || '';
    state.branchSwitcher = __MARKFLOW_CONFIG__.branchSwitcher || false;

    if (__MARKFLOW_CONTENT__) {
      // Pre-baked: populate file cache from base64 content
      prebakeLoad();
    } else {
      // Client-side fetch mode
      fetchTree();
    }
    if (state.branchSwitcher) {
      fetchBranches();
    }
  } else {
    initFromHash();
  }
})();

// ─── PRE-BAKED CONTENT LOADER ───
function prebakeLoad() {
  const files = __MARKFLOW_CONTENT__.files;
  const paths = Object.keys(files).sort();
  paths.forEach(function(p) {
    state.fileCache.set(p, new TextDecoder().decode(Uint8Array.from(atob(files[p]), function(c) { return c.charCodeAt(0); })));
  });
  state.allFiles = new Set(paths.filter(function(p) { return isMarkdown(p); }));
  buildPages().then(function() {
    if (state.pages.length > 0) {
      document.getElementById('stepNav').style.display = 'flex';
      loadPage(0);
    }
  });
}

// ─── BRANCH / TAG DROPDOWN ───
async function fetchBranches() {
  try {
    const url = 'https://api.github.com/repos/' + state.owner + '/' + state.repo + '/branches?per_page=100';
    const res = await fetch(url);
    if (!res.ok) return;
    const branches = await res.json();
    const wrap = document.getElementById('branchDropdownWrap');
    const select = document.getElementById('branchDropdown');
    if (!branches.length) return;
    wrap.style.display = 'block';
    select.innerHTML = '';
    branches.forEach(function(b) {
      var opt = document.createElement('option');
      opt.value = b.name;
      opt.textContent = b.name;
      if (b.name === state.branch) opt.selected = true;
      select.appendChild(opt);
    });
    // Also fetch tags
    var tagRes = await fetch('https://api.github.com/repos/' + state.owner + '/' + state.repo + '/tags?per_page=50');
    if (tagRes.ok) {
      var tags = await tagRes.json();
      if (tags.length) {
        var group = document.createElement('optgroup');
        group.label = 'Tags';
        tags.forEach(function(t) {
          var opt = document.createElement('option');
          opt.value = t.name;
          opt.textContent = t.name;
          if (t.name === state.branch) opt.selected = true;
          group.appendChild(opt);
        });
        select.appendChild(group);
      }
    }
  } catch(e) { /* ignore */ }
}

function onBranchChange(val) {
  if (!val || val === state.branch) return;
  state.branch = val;
  state.fileCache.clear();
  state.allFiles.clear();
  state.pages = [];
  state.sections = [];
  state.currentPage = -1;
  fetchTree();
}

// ─── CONFIG ───
function fillConfig(owner, repo, branch, root) {
  document.getElementById('cfgOwner').value = owner;
  document.getElementById('cfgRepo').value = repo;
  document.getElementById('cfgBranch').value = branch;
  document.getElementById('cfgRoot').value = root;
}
async function loadRepo() {
  state.owner = document.getElementById('cfgOwner').value.trim();
  state.repo = document.getElementById('cfgRepo').value.trim();
  state.branch = document.getElementById('cfgBranch').value.trim() || 'main';
  state.root = document.getElementById('cfgRoot').value.trim().replace(/^\/|\/$/g, '');
  state.giscusRepo = document.getElementById('cfgGiscus').value.trim();
  if (!state.owner || !state.repo) return;
  if (state.root) localStorage.setItem('markflow:' + state.owner + '/' + state.repo + ':root', state.root);
  var hashBase = state.owner + '/' + state.repo + '/' + state.branch;
  window.location.hash = state.root ? hashBase + '/' + state.root : hashBase;
  await fetchTree();
}

// ─── GITHUB API ───
async function fetchTree() {
  showLoading('Fetching repository tree\u2026');
  try {
    var url = 'https://api.github.com/repos/' + state.owner + '/' + state.repo + '/git/trees/' + state.branch + '?recursive=1';
    var res = await fetch(url);
    if (!res.ok) throw new Error('GitHub API ' + res.status + ': ' + res.statusText);
    var data = await res.json();
    var items = data.tree || [];
    if (state.root) {
      var prefix = state.root + '/';
      items = items
        .filter(function(i) { return i.path.startsWith(prefix); })
        .map(function(i) { return Object.assign({}, i, { path: i.path.slice(prefix.length) }); })
        .filter(function(i) { return i.path; });
    }
    state.allFiles = new Set(items.filter(function(i) { return i.type === 'blob' && isMarkdown(i.path); }).map(function(i) { return i.path; }));
    await buildPages();
    if (state.pages.length > 0) {
      document.getElementById('stepNav').style.display = 'flex';
      var hashPath = getPathFromHash();
      var pageIdx = hashPath ? state.pages.findIndex(function(p) { return p.path === hashPath; }) : 0;
      if (pageIdx < 0) pageIdx = 0;
      await loadPage(pageIdx);
    } else {
      showError('No markdown files found in this path.');
    }
  } catch (err) {
    showError(err.message);
  }
}

async function fetchFile(path) {
  if (state.fileCache.has(path)) return state.fileCache.get(path);
  var fullPath = state.root ? state.root + '/' + path : path;
  var url = 'https://raw.githubusercontent.com/' + state.owner + '/' + state.repo + '/' + state.branch + '/' + fullPath;
  var res = await fetch(url);
  if (!res.ok) throw new Error('Failed to fetch ' + path + ': ' + res.status);
  var text = await res.text();
  state.fileCache.set(path, text);
  return text;
}

// ─── BUILD PAGES FROM SUMMARY.md OR TREE ───
async function buildPages() {
  var candidates = ['SUMMARY.md', 'summary.md', 'INDEX.md', 'index.md', 'README.md', 'readme.md'];
  var summaryPath = null;
  for (var i = 0; i < candidates.length; i++) {
    if (state.allFiles.has(candidates[i])) { summaryPath = candidates[i]; break; }
  }
  if (summaryPath) {
    try {
      var raw = await fetchFile(summaryPath);
      var parsed = parseSummaryToSections(raw);
      if (parsed.length > 0 && parsed.some(function(s) { return s.pages.length > 0; })) {
        state.sections = parsed;
      } else {
        state.sections = buildSectionsFromTree();
      }
    } catch(e) {
      state.sections = buildSectionsFromTree();
    }
  } else {
    state.sections = buildSectionsFromTree();
  }
  state.pages = [];
  state.sections.forEach(function(sec, si) {
    sec.pages.forEach(function(p) {
      state.pages.push({ title: p.title, path: p.path, sectionIdx: si });
    });
  });
  renderPageDropdown();
}

function parseSummaryToSections(raw) {
  var result = parseFrontmatter(raw);
  var lines = result.body.split('\n');
  var sections = [];
  var current = { name: 'All', pages: [] };
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];
    var headerMatch = line.match(/^#{1,3}\s+(.+)/);
    if (headerMatch) {
      if (current.pages.length > 0) sections.push(current);
      current = { name: headerMatch[1].trim(), pages: [] };
      continue;
    }
    var m = line.match(/^\s*[*\-+]?\s*(?:\d+\.\s*)?\[([^\]]+)\]\(([^)]+)\)/);
    if (!m) continue;
    var title = m[1].trim();
    var href = m[2].trim().replace(/^\.\//, '').replace(/^\//, '');
    var cleanHref = href.split('#')[0];
    if (cleanHref && !state.allFiles.has(cleanHref)) {
      if (state.allFiles.has(cleanHref + '.md')) href = cleanHref + '.md';
    }
    if (cleanHref && (state.allFiles.has(cleanHref) || state.allFiles.has(cleanHref + '.md'))) {
      current.pages.push({ title: title, path: cleanHref });
    }
  }
  if (current.pages.length > 0) sections.push(current);
  return sections;
}

function buildSectionsFromTree() {
  var dirMap = new Map();
  var rootFiles = [];
  state.allFiles.forEach(function(filePath) {
    if (/^(summary|index|readme)\.md$/i.test(filePath.split('/').pop())) return;
    var parts = filePath.split('/');
    if (parts.length === 1) {
      rootFiles.push({ title: formatName(parts[0], true), path: filePath });
    } else {
      var dir = parts[0];
      if (!dirMap.has(dir)) dirMap.set(dir, []);
      dirMap.get(dir).push({ title: formatName(parts[parts.length - 1], true), path: filePath });
    }
  });
  var sections = [];
  if (rootFiles.length > 0) {
    rootFiles.sort(function(a, b) { return a.path.localeCompare(b.path); });
    sections.push({ name: 'Overview', pages: rootFiles });
  }
  var dirs = Array.from(dirMap.keys()).sort();
  dirs.forEach(function(dir) {
    var pages = dirMap.get(dir).sort(function(a, b) { return a.path.localeCompare(b.path); });
    sections.push({ name: formatName(dir), pages: pages });
  });
  if (sections.length === 0) sections.push({ name: 'All', pages: [] });
  return sections;
}

// ─── PAGE DROPDOWN ───
function renderPageDropdown() {
  var wrap = document.getElementById('folderDropdownWrap');
  var select = document.getElementById('folderDropdown');
  if (state.pages.length <= 1) { wrap.style.display = 'none'; return; }
  wrap.style.display = 'block';
  select.innerHTML = '';
  if (state.sections.length <= 1) {
    state.pages.forEach(function(page, i) {
      var opt = document.createElement('option');
      opt.value = i;
      opt.textContent = page.title;
      select.appendChild(opt);
    });
  } else {
    var pageIdx = 0;
    state.sections.forEach(function(sec) {
      var group = document.createElement('optgroup');
      group.label = sec.name;
      sec.pages.forEach(function(page) {
        var opt = document.createElement('option');
        opt.value = pageIdx;
        opt.textContent = page.title;
        group.appendChild(opt);
        pageIdx++;
      });
      select.appendChild(group);
    });
  }
}

function onFolderChange(val) {
  var idx = parseInt(val, 10);
  if (isNaN(idx) || idx < 0 || idx >= state.pages.length) return;
  loadPage(idx);
}

// ─── LOAD PAGE & EXTRACT STEPS (H2 SECTIONS) ───
async function loadPage(pageIdx) {
  if (pageIdx < 0 || pageIdx >= state.pages.length) return;
  state.currentPage = pageIdx;
  state.currentStep = 0;
  var page = state.pages[pageIdx];

  var select = document.getElementById('folderDropdown');
  if (select) select.value = pageIdx;

  if (!__MARKFLOW_CONFIG__) {
    var hashBase = state.owner + '/' + state.repo + '/' + state.branch;
    var fullHash = state.root
      ? hashBase + '/' + state.root + '/' + page.path
      : hashBase + '/' + page.path;
    history.pushState(null, '', '#' + fullHash);
  }

  document.getElementById('breadcrumb').innerHTML = '<span>' + escapeHtml(page.title) + '</span>';
  closeSidebar();
  await renderPage(page);
  window.scrollTo(0, 0);
}

async function renderPage(page) {
  var content = document.getElementById('contentArea');
  showLoading('Loading\u2026');
  try {
    var raw = await fetchFile(page.path);
    var result = parseFrontmatter(raw);
    var html = parseMarkdown(result.body);
    var displayName = result.frontmatter.title || page.title;

    var articleHTML = '<div class="fade-in">';
    articleHTML += '<div class="article-meta"><h1>' + escapeHtml(displayName) + '</h1>';
    articleHTML += '<div class="meta-row">';
    if (result.frontmatter.date) articleHTML += '<span>' + result.frontmatter.date + '</span>';
    if (result.frontmatter.tags) {
      var tags = Array.isArray(result.frontmatter.tags) ? result.frontmatter.tags : result.frontmatter.tags.split(',');
      articleHTML += tags.map(function(t) { return '<span class="tag">' + escapeHtml(t.trim()) + '</span>'; }).join('');
    }
    articleHTML += '</div></div>';
    articleHTML += '<div class="markdown-body">' + html + '</div>';
    if (state.giscusRepo) {
      articleHTML += '<div class="comments-section"><h3>Discussion</h3><div id="giscusContainer"></div></div>';
    }
    articleHTML += '</div>';
    content.innerHTML = articleHTML;
    addCodeCopyButtons();
    hljs.highlightAll();
    if (state.giscusRepo) loadGiscus(page.path);

    // Build steps with children (h3/h4 nested under h2)
    var allHeadings = extractHeadings(result.body);
    state.steps = [];
    var currentH2 = null;
    allHeadings.forEach(function(h) {
      if (h.depth === 2) {
        currentH2 = { text: h.text, id: h.id, children: [] };
        state.steps.push(currentH2);
      } else if (currentH2 && (h.depth === 3 || h.depth === 4)) {
        currentH2.children.push(h);
      }
    });
    state.currentStep = 0;
    renderStepList();
    updateStepNav();
    setupStepScrollSpy();
  } catch (err) {
    showError(err.message);
  }
}

// ─── STEP LIST (h2 sections + h3/h4 sub-items in left sidebar) ───
function renderStepList() {
  var list = document.getElementById('stepList');
  list.innerHTML = '';
  if (state.steps.length === 0) {
    list.innerHTML = '<li style="padding:12px 16px;color:var(--text-muted);font-size:0.8rem;font-style:italic;">No sections</li>';
    return;
  }
  state.steps.forEach(function(step, i) {
    var li = document.createElement('li');
    li.className = 'step-item' + (i === state.currentStep ? ' active' : '') + (i < state.currentStep ? ' completed' : '');
    li.innerHTML = '<span class="step-number">' + (i + 1) + '</span><span class="step-title">' + escapeHtml(step.text) + '</span>';
    li.onclick = function() { scrollToStep(i); };
    list.appendChild(li);
    // Sub-items (h3/h4) — only show for active step
    if (i === state.currentStep && step.children && step.children.length > 0) {
      var subUl = document.createElement('ul');
      subUl.className = 'step-sub-list';
      step.children.forEach(function(child) {
        var subLi = document.createElement('li');
        subLi.className = 'step-sub-item' + (child.depth === 4 ? ' depth-4' : '');
        subLi.setAttribute('data-id', child.id);
        subLi.textContent = child.text;
        subLi.onclick = function(e) { e.stopPropagation(); scrollToId(child.id); };
        subUl.appendChild(subLi);
      });
      list.appendChild(subUl);
    }
  });
}

function scrollToStep(idx) {
  if (idx < 0 || idx >= state.steps.length) return;
  state.currentStep = idx;
  var step = state.steps[idx];
  var el = document.getElementById(step.id);
  if (el) {
    var top = el.getBoundingClientRect().top + window.pageYOffset - 80;
    window.scrollTo({ top: top, behavior: 'smooth' });
  }
  renderStepList();
  updateStepNav();
}

function setupStepScrollSpy() {
  if (state.stepObserver) { state.stepObserver.disconnect(); state.stepObserver = null; }
  if (state.steps.length === 0) return;
  // Collect all heading IDs (h2 steps + h3/h4 children)
  var allIds = [];
  state.steps.forEach(function(step) {
    allIds.push({ id: step.id, type: 'step' });
    if (step.children) step.children.forEach(function(c) {
      allIds.push({ id: c.id, type: 'sub' });
    });
  });
  if (allIds.length === 0) return;
  state.stepObserver = new IntersectionObserver(function(entries) {
    for (var i = 0; i < entries.length; i++) {
      var entry = entries[i];
      if (!entry.isIntersecting) continue;
      var id = entry.target.id;
      // Check if it's a step (h2)
      var stepIdx = state.steps.findIndex(function(s) { return s.id === id; });
      if (stepIdx >= 0 && stepIdx !== state.currentStep) {
        state.currentStep = stepIdx;
        renderStepList();
        updateStepNav();
        var activeEl = document.querySelector('.step-item.active');
        if (activeEl) activeEl.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
      }
      // Highlight active sub-item
      document.querySelectorAll('.step-sub-item').forEach(function(el) { el.classList.remove('active'); });
      var subEl = document.querySelector('.step-sub-item[data-id="' + id + '"]');
      if (subEl) subEl.classList.add('active');
    }
  }, { rootMargin: '-80px 0px -60% 0px', threshold: 0 });
  allIds.forEach(function(item) {
    var el = document.getElementById(item.id);
    if (el) state.stepObserver.observe(el);
  });
}

// ─── SCROLL TO ID (respects step navigation) ───
function scrollToId(id) {
  var el = document.getElementById(id);
  if (!el) return;
  var stepIdx = state.steps.findIndex(function(s) { return s.id === id; });
  if (stepIdx >= 0) {
    state.currentStep = stepIdx;
    renderStepList();
    updateStepNav();
  }
  var top = el.getBoundingClientRect().top + window.pageYOffset - 80;
  window.scrollTo({ top: top, behavior: 'smooth' });
}

// ─── STEP NAVIGATION (Back/Next) ───
function nextStep() {
  if (state.steps.length > 0 && state.currentStep < state.steps.length - 1) {
    scrollToStep(state.currentStep + 1);
  } else if (state.currentPage < state.pages.length - 1) {
    loadPage(state.currentPage + 1);
  }
}
function prevStep() {
  if (state.steps.length > 0 && state.currentStep > 0) {
    scrollToStep(state.currentStep - 1);
  } else if (state.currentPage > 0) {
    loadPage(state.currentPage - 1);
  }
}
function updateStepNav() {
  var back = document.getElementById('btnBack');
  var next = document.getElementById('btnNext');
  var counter = document.getElementById('stepCounter');
  var atStart = state.currentStep <= 0 && state.currentPage <= 0;
  var atEnd = (state.steps.length === 0 || state.currentStep >= state.steps.length - 1) && state.currentPage >= state.pages.length - 1;
  back.classList.toggle('disabled', atStart);
  next.classList.toggle('disabled', atEnd);
  if (state.steps.length > 0) {
    counter.textContent = 'Section ' + (state.currentStep + 1) + ' of ' + state.steps.length;
  } else {
    counter.textContent = 'Page ' + (state.currentPage + 1) + ' of ' + state.pages.length;
  }
}

// ─── MARKDOWN PARSING (Marked.js v12) ───
function parseMarkdown(text) {
  var renderer = new marked.Renderer();
  renderer.image = function(hrefOrToken, titleArg, textArg) {
    var href, title, text;
    if (typeof hrefOrToken === 'object') {
      href = hrefOrToken.href || ''; title = hrefOrToken.title || ''; text = hrefOrToken.text || '';
    } else {
      href = hrefOrToken || ''; title = titleArg || ''; text = textArg || '';
    }
    if (text && text.toLowerCase() === 'youtube') {
      var videoId = extractYouTubeId(href);
      if (videoId) {
        return '<div class="youtube-embed"><iframe src="https://www.youtube-nocookie.com/embed/' + videoId + '" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen loading="lazy"></iframe></div>';
      }
    }
    var titleAttr = title ? ' title="' + escapeHtml(title) + '"' : '';
    return '<img src="' + href + '" alt="' + text + '"' + titleAttr + ' />';
  };
  renderer.heading = function(textOrToken, level, raw) {
    var text, depth;
    if (typeof textOrToken === 'object') {
      text = textOrToken.text || '';
      depth = textOrToken.depth || 2;
    } else {
      text = textOrToken || '';
      depth = level || 2;
    }
    var plainText = String(text).replace(/<[^>]*>/g, '');
    var id = plainText.toLowerCase().replace(/[^\w]+/g, '-').replace(/^-|-$/g, '');
    return '<h' + depth + ' id="' + id + '">' + text + '</h' + depth + '>';
  };
  renderer.link = function(hrefOrToken, titleArg, textArg) {
    var href, title, text;
    if (typeof hrefOrToken === 'object') {
      href = hrefOrToken.href || ''; title = hrefOrToken.title || ''; text = hrefOrToken.text || '';
    } else {
      href = hrefOrToken || ''; title = titleArg || ''; text = textArg || '';
    }
    var titleAttr = title ? ' title="' + escapeHtml(title) + '"' : '';
    if (href && !href.startsWith('http') && !href.startsWith('#') && isMarkdown(href.split('#')[0])) {
      var cleanPath = href.replace(/^\.\//, '').replace(/^\//, '').split('#')[0];
      var pageIdx = state.pages.findIndex(function(p) { return p.path === cleanPath; });
      if (pageIdx >= 0) {
        return '<a href="javascript:void(0)" onclick="loadPage(' + pageIdx + ')"' + titleAttr + '>' + text + '</a>';
      }
    }
    if (href && href.startsWith('#')) {
      var id = href.slice(1);
      return '<a href="javascript:void(0)" onclick="scrollToId(\'' + id + '\')"' + titleAttr + '>' + text + '</a>';
    }
    return '<a href="' + href + '" target="_blank" rel="noopener"' + titleAttr + '>' + text + '</a>';
  };
  marked.setOptions({ renderer: renderer, gfm: true, breaks: false });
  return marked.parse(text);
}

function extractYouTubeId(input) {
  if (/^[a-zA-Z0-9_-]{11}$/.test(input)) return input;
  var patterns = [
    /(?:youtube\.com\/watch\?v=|youtu\.be\/|youtube\.com\/embed\/)([a-zA-Z0-9_-]{11})/,
    /youtube\.com\/v\/([a-zA-Z0-9_-]{11})/
  ];
  for (var i = 0; i < patterns.length; i++) { var m = input.match(patterns[i]); if (m) return m[1]; }
  return null;
}
function parseFrontmatter(raw) {
  var match = raw.match(/^---\s*\n([\s\S]*?)\n---\s*\n([\s\S]*)$/);
  if (!match) return { frontmatter: {}, body: raw };
  var fm = {};
  match[1].split('\n').forEach(function(line) {
    var idx = line.indexOf(':');
    if (idx > 0) {
      var key = line.slice(0, idx).trim();
      var val = line.slice(idx + 1).trim();
      if (val.startsWith('[') && val.endsWith(']')) {
        val = val.slice(1, -1).split(',').map(function(s) { return s.trim().replace(/^["']|["']$/g, ''); });
      }
      fm[key] = val;
    }
  });
  return { frontmatter: fm, body: match[2] };
}
function extractHeadings(markdown) {
  var headings = [];
  var lines = markdown.split('\n');
  var inCode = false;
  for (var i = 0; i < lines.length; i++) {
    var line = lines[i];
    if (line.trim().startsWith('```')) { inCode = !inCode; continue; }
    if (inCode) continue;
    var m = line.match(/^(#{2,4})\s+(.+)/);
    if (m) {
      var text = m[2].replace(/\*\*|__|`/g, '');
      var id = text.toLowerCase().replace(/[^\w]+/g, '-').replace(/^-|-$/g, '');
      headings.push({ depth: m[1].length, text: text, id: id });
    }
  }
  return headings;
}

// ─── GISCUS ───
function loadGiscus(path) {
  var container = document.getElementById('giscusContainer');
  if (!container || !state.giscusRepo) return;
  container.innerHTML = '';
  var script = document.createElement('script');
  script.src = 'https://giscus.app/client.js';
  script.setAttribute('data-repo', state.giscusRepo);
  script.setAttribute('data-repo-id', '');
  script.setAttribute('data-category', (__MARKFLOW_CONFIG__ && __MARKFLOW_CONFIG__.giscus && __MARKFLOW_CONFIG__.giscus.category) || 'General');
  script.setAttribute('data-category-id', '');
  script.setAttribute('data-mapping', 'pathname');
  script.setAttribute('data-strict', '0');
  script.setAttribute('data-reactions-enabled', '1');
  script.setAttribute('data-emit-metadata', '0');
  script.setAttribute('data-input-position', 'top');
  script.setAttribute('data-theme', 'dark_dimmed');
  script.setAttribute('data-lang', 'en');
  script.setAttribute('crossorigin', 'anonymous');
  script.async = true;
  container.appendChild(script);
}

// ─── UTILITIES ───
function formatName(name, stripExt) {
  if (stripExt) name = name.replace(/\.(md|markdown|mdx)$/i, '');
  return name.replace(/[-_]/g, ' ').replace(/\b\w/g, function(c) { return c.toUpperCase(); });
}
function isMarkdown(name) { return /\.(md|markdown|mdx)$/i.test(name); }
function escapeHtml(str) {
  var div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}
function showLoading(msg) {
  document.getElementById('contentArea').innerHTML = '<div class="loading-state"><div class="spinner"></div><span>' + msg + '</span></div>';
}
function showError(msg) {
  document.getElementById('contentArea').innerHTML = '<div class="error-state"><p>Something went wrong</p><code>' + escapeHtml(msg) + '</code></div>';
}
function addCodeCopyButtons() {
  document.querySelectorAll('.markdown-body pre').forEach(function(pre) {
    var btn = document.createElement('button');
    btn.className = 'code-copy-btn';
    btn.textContent = 'copy';
    btn.onclick = function() {
      var code = pre.querySelector('code');
      navigator.clipboard.writeText(code.textContent).then(function() {
        btn.textContent = 'copied!';
        setTimeout(function() { btn.textContent = 'copy'; }, 1500);
      });
    };
    pre.style.position = 'relative';
    pre.appendChild(btn);
  });
}
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('mobile-open');
  document.getElementById('sidebarOverlay').classList.toggle('visible');
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('mobile-open');
  document.getElementById('sidebarOverlay').classList.remove('visible');
}

// ─── HASH ROUTING ───
function getPathFromHash() {
  var hash = window.location.hash.slice(1);
  if (!hash) return '';
  var prefix = state.root
    ? state.owner + '/' + state.repo + '/' + state.branch + '/' + state.root
    : state.owner + '/' + state.repo + '/' + state.branch;
  if (hash.startsWith(prefix + '/')) return hash.slice(prefix.length + 1);
  if (hash === prefix) return '';
  return '';
}
function initFromHash() {
  var hash = window.location.hash.slice(1);
  if (!hash) return;
  var parts = hash.split('/');
  if (parts.length >= 3) {
    document.getElementById('cfgOwner').value = parts[0];
    document.getElementById('cfgRepo').value = parts[1];
    document.getElementById('cfgBranch').value = parts[2];
    state.owner = parts[0];
    state.repo = parts[1];
    state.branch = parts[2];
    var savedRoot = localStorage.getItem('markflow:' + parts[0] + '/' + parts[1] + ':root');
    if (savedRoot) {
      state.root = savedRoot;
      document.getElementById('cfgRoot').value = savedRoot;
    }
    fetchTree();
  }
}
window.addEventListener('popstate', function() {
  if (state.pages.length) {
    var path = getPathFromHash();
    var idx = state.pages.findIndex(function(p) { return p.path === path; });
    if (idx >= 0 && idx !== state.currentPage) loadPage(idx);
  }
});
// Keyboard navigation
document.addEventListener('keydown', function(e) {
  if (!state.pages.length) return;
  if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
  if (e.key === 'ArrowRight' || e.key === 'ArrowDown') { e.preventDefault(); nextStep(); }
  if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') { e.preventDefault(); prevStep(); }
});
</script>
</body>
</html>
